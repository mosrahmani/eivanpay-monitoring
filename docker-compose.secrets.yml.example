version: '3.8'

# Docker Secrets Example
# Copy to docker-compose.secrets.yml and use with:
# docker compose -f docker-compose.yml -f docker-compose.secrets.yml up -d

# First, create secrets:
# echo "your_postgres_password" | docker secret create postgres_password -
# echo "your_redis_password" | docker secret create redis_password -
# echo "your_telegram_bot_token" | docker secret create telegram_bot_token -
# echo "your_telegram_chat_id" | docker secret create telegram_chat_id -
# echo "your_grafana_admin_password" | docker secret create grafana_admin_password -

services:
  postgres-exporter:
    secrets:
      - postgres_password
    environment:
      - DATA_SOURCE_NAME=postgresql://${POSTGRES_USER}:/run/secrets/postgres_password@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}?sslmode=disable

  redis-exporter:
    secrets:
      - redis_password
    environment:
      - REDIS_PASSWORD_FILE=/run/secrets/redis_password

  telegram-webhook:
    secrets:
      - telegram_bot_token
      - telegram_chat_id
    environment:
      - TELEGRAM_BOT_TOKEN_FILE=/run/secrets/telegram_bot_token
      - TELEGRAM_CHAT_ID_FILE=/run/secrets/telegram_chat_id
      - PORT=8080
      - METRICS_PORT=9091

  grafana:
    secrets:
      - grafana_admin_password
    environment:
      - GF_SECURITY_ADMIN_PASSWORD_FILE=/run/secrets/grafana_admin_password

secrets:
  postgres_password:
    external: true
  redis_password:
    external: true
  telegram_bot_token:
    external: true
  telegram_chat_id:
    external: true
  grafana_admin_password:
    external: true

